#!/usr/bin/env node
process.env.NODE_ENV = 'development'

const program = require('commander')
const portfinder = require('portfinder')
const open = require('open')
const express = require('express')
const webpack = require('webpack')
const WebpackDevServer = require('webpack-dev-server')
const devWebpackConfig = require('../lib/webpack/webpack.dev.config')
const logger = require('../lib/logger')
const configs = require('../lib/configs')
const utils = require('../lib/utils')
const opts = configs.abcOpts

program
  .option('-p,--port [port]', 'Server port')
  .option('-H,--host [host]', 'Server host')
  .parse(process.argv)

let PORT = program.port || 7777;
let HOST = program.host || 'localhost'

portfinder.basePort = PORT
portfinder.getPort((err, port) => {
  if (err) logger.fatal(err)

  let uri = `http://${HOST}:${port}/`

  if (opts.hotReplace) {
    Object.keys(configs.entries).forEach((name) => {
      devWebpackConfig.entry[name] = [`webpack-dev-server/client?${uri}`].concat(devWebpackConfig.entry[name])
    })
  }
  let compiler = webpack(devWebpackConfig)
  let server = new WebpackDevServer(compiler, {
    host: HOST,
    before(app) {
      logger.log('starting dev server...')
      app.use('/static', express.static(utils.cwd('./static')))

      // mock data
      const mockPath = utils.cwd('./mock')
      if (opts.mockData && fs.existsSync(mockPath)) {
        const mockRouter = express.Router()
        mockRouter.all('/:method', (req, res) => {
          let method = req.params.method.replace(/\.json$/, '')
          let jsonPath = path.join(mockPath, method + '.json')
          delete require.cache[require.resolve(jsonPath)]
          let data = require(jsonPath)
          res.json(data)
        });
        app.use('/mock-api', mockRouter)
      }
    },
    after() {
      if (opts.autoOpen === true && process.env.NODE_ENV !== 'testing') {
        let page = opts.mainPage ? opts.mainPage : Object.keys(configs.entries)[0]
        open(`${uri}${page}.html`)
      }

    }
  })

  server.listen(port)
})
